@model MovieList.Core.DTOs.Movie.MovieDetailDto

@{
    ViewData["Title"] = Model.Title;
}

<div class="row">
    <!-- Sol Taraf - Poster ve Aksiyonlar -->
    <div class="col-md-3">
        @if (!string.IsNullOrEmpty(Model.PosterPath))
        {
            <img src="@Model.FullPosterUrl" class="img-fluid rounded shadow" alt="@Model.Title" style="border: 2px solid var(--accent-green);">
        }
        else
        {
            <div class="d-flex align-items-center justify-content-center rounded"
                 style="height: 450px; background-color: var(--card-bg); color: var(--accent-green);">
                <i class="fas fa-film fa-5x"></i>
            </div>
        }

        <!-- Aksiyonlar -->
        <div class="mt-3 d-grid gap-2">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <!-- İzledim Butonu -->
                @if (Model.IsWatched)
                {
                    <button class="btn btn-success" onclick="unmarkAsWatched(@Model.Id)">
                        <i class="fas fa-check"></i> İzlendi ✓
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" onclick="markAsWatched(@Model.Id)">
                        <i class="fas fa-check"></i> İzledim
                    </button>
                }

                <!-- Watchlist Butonu -->
                @if (Model.IsInWatchlist)
                {
                    <button class="btn btn-secondary" onclick="removeFromWatchlist(@Model.Id)">
                        <i class="fas fa-bookmark"></i> Watchlist'te ✓
                    </button>
                }
                else if (!Model.IsWatched)
                {
                    <!-- Sadece izlenmediyse watchlist'e eklenebilir -->
                    <button class="btn btn-outline-light" onclick="addToWatchlist(@Model.Id)">
                        <i class="fas fa-bookmark"></i> Watchlist'e Ekle
                    </button>
                }

                <!-- Beğen Butonu - Toggle -->
                <button class="btn @(Model.IsLikedByUser ? "btn-danger" : "btn-outline-light")"
                        style="@(Model.IsLikedByUser ? "" : "color: #ff6b6b; border-color: #ff6b6b;")"
                        onclick="toggleLike(@Model.Id)">
                    <i class="fas fa-heart"></i> @(Model.IsLikedByUser ? "Beğenildi" : "Beğen")
                </button>
            }
            else
            {
                <!-- Giriş Yapılmamış -->
                <button class="btn btn-primary" onclick="showLoginAlert()">
                    <i class="fas fa-check"></i> İzledim
                </button>
                <button class="btn btn-outline-light" onclick="showLoginAlert()">
                    <i class="fas fa-bookmark"></i> Watchlist'e Ekle
                </button>
                <button class="btn btn-outline-light" style="color: #ff6b6b; border-color: #ff6b6b;" onclick="showLoginAlert()">
                    <i class="fas fa-heart"></i> Beğen
                </button>
            }
        </div>

        <!-- Puan Ver -->
        <div class="mt-3 card">
            <div class="card-body text-center">
                <h6 class="mb-2">Puan Ver</h6>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="d-flex justify-content-between flex-wrap gap-1">
                        @for (int i = 1; i <= 10; i++)
                        {
                            var isSelected = Model.UserRating == i;
                            <button class="btn btn-sm @(isSelected ? "btn-warning" : "")"
                                    style="@(isSelected ? "" : "border: 1px solid var(--accent-green); color: var(--accent-cream);")"
                                    onclick="rateMovie(@Model.Id, @i)">
                                @i
                            </button>
                        }
                    </div>
                    @if (Model.UserRating.HasValue)
                    {
                        <small class="text-muted mt-2 d-block">Puanınız: @Model.UserRating/10</small>
                    }
                }
                else
                {
                    <p class="text-muted mb-0">
                        <small>Puan vermek için <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" style="color: var(--accent-green);">giriş yapın</a></small>
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- Sağ Taraf - Film Bilgileri -->
    <div class="col-md-9">
        <h1 class="mb-3 display-4">@Model.Title</h1>

        <div class="mb-4">
            @if (Model.ReleaseDate.HasValue)
            {
                <span class="badge bg-secondary me-2 p-2">@Model.ReleaseDate.Value.Year</span>
            }
            @if (Model.Runtime.HasValue)
            {
                <span class="badge bg-secondary me-2 p-2">@Model.Runtime dk</span>
            }
            @if (Model.VoteAverage.HasValue)
            {
                <span class="badge bg-warning p-2">TMDB: @Model.VoteAverage.Value.ToString("0.0")</span>
            }
        </div>

        <div class="p-4 rounded" style="background-color: var(--card-bg);">
            <h4 class="text-muted mb-3">Özet</h4>
            <p class="lead" style="font-size: 1.1rem;">@Model.Overview</p>
        </div>

        <!-- İstatistikler -->
        <div class="row mt-4 text-center">
            <div class="col-md-3">
                <div class="p-3 rounded border border-secondary">
                    <i class="fas fa-eye fa-2x mb-2" style="color: var(--accent-green);"></i>
                    <h3>@Model.WatchCount</h3>
                    <span class="text-muted">İzlenme</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 rounded border border-secondary">
                    <i class="fas fa-heart fa-2x mb-2 text-danger"></i>
                    <h3>@Model.LikeCount</h3>
                    <span class="text-muted">Beğeni</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 rounded border border-secondary">
                    <i class="fas fa-star fa-2x mb-2 text-warning"></i>
                    @if (Model.UserAverageRating.HasValue)
                    {
                        <h3>@Model.UserAverageRating.Value.ToString("0.0")</h3>
                        <span class="text-muted">@Model.UserRatingCount Kullanıcı Puanı</span>
                    }
                    else
                    {
                        <h3>-</h3>
                        <span class="text-muted">Henüz puan yok</span>
                    }
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 rounded border border-secondary">
                    <i class="fas fa-comment fa-2x mb-2" style="color: var(--accent-cream);"></i>
                    <h3>@Model.Reviews.Count</h3>
                    <span class="text-muted">Yorum</span>
                </div>
            </div>
        </div>

        <!-- Yorumlar -->
        <div class="mt-5">
            <h3 class="mb-4 border-bottom pb-2" style="border-color: var(--accent-green) !important;">
                Kullanıcı Yorumları
            </h3>

            @if (User.Identity?.IsAuthenticated == true)
            {
                <!-- Yorum Yazma Formu - Sadece Giriş Yapmışlar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="Bu film hakkında ne düşünüyorsun?" id="reviewContent"></textarea>
                        <button class="btn btn-primary float-end" onclick="submitReview(@Model.Id)">
                            <i class="fas fa-paper-plane"></i> Gönder
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- Giriş Yapılmamış - Yorum Yazamaz -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <p class="text-muted mb-2">
                            <i class="fas fa-lock"></i> Yorum yazmak için giriş yapmalısınız
                        </p>
                        <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-primary btn-sm">
                            Giriş Yap
                        </a>
                    </div>
                </div>
            }

            <!-- Yorumlar Listesi -->
            @if (Model.Reviews.Any())
            {
                @foreach (var review in Model.Reviews)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(review.UserProfileImage))
                                    {
                                        <img src="@review.UserProfileImage"
                                             class="rounded-circle me-3"
                                             style="width: 50px; height: 50px; object-fit: cover;"
                                             alt="@review.Username">
                                    }
                                    else
                                    {
                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-3"
                                             style="width: 50px; height: 50px; background-color: var(--main-bg); color: var(--accent-cream);">
                                            <i class="fas fa-user"></i>
                                        </div>
                                    }
                                    <div>
                                        <h6 class="mb-0">
                                            <a asp-controller="Profile" asp-action="Index" asp-route-id="@review.UserId" style="color: var(--accent-cream); text-decoration: none;">
                                                @review.Username
                                            </a>
                                        </h6>
                                        <small class="text-muted">@review.CreatedDate.ToString("dd MMMM yyyy")</small>
                                    </div>
                                </div>
                                <span class="badge bg-secondary">
                                    <i class="fas fa-thumbs-up"></i> @review.LikeCount
                                </span>
                            </div>
                            <hr style="border-color: var(--accent-green);">
                            <p class="mt-3 mb-0">@review.Content</p>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Henüz yorum yapılmamış. İlk yorumu siz yapın!</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        function showLoginAlert() {
            alert('Bu özelliği kullanmak için giriş yapmalısınız!');
            window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
        }

        function markAsWatched(movieId) {
            if (!token) return;

            fetch('/UserMovie/MarkAsWatched/' + movieId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function unmarkAsWatched(movieId) {
            if (confirm('Bu filmi izlenmedi olarak işaretlemek istediğinize emin misiniz? (Puanınız da kaldırılacak)')) {
                fetch('/UserMovie/UnmarkAsWatched/' + movieId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function toggleLike(movieId) {
            if (!token) return;

            fetch('/UserMovie/ToggleLike/' + movieId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function rateMovie(movieId, rating) {
            if (!token) return;

            fetch(`/UserMovie/Rate/${movieId}?rating=${rating}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function addToWatchlist(movieId) {
            if (!token) return;

            fetch('/Watchlist/Add/' + movieId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function removeFromWatchlist(movieId) {
            if (!token) return;

            fetch('/Watchlist/Remove/' + movieId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function submitReview(movieId) {
            alert('Review özelliği yakında eklenecek!');
        }
    </script>
}